<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f6fa;
  --surface: #ffffff;
  --surface2: #f0f1f7;
  --border: #e2e4ed;
  --accent: #3b5bdb;
  --accent-light: #eef2ff;
  --success: #2f9e44;
  --success-light: #ebfbee;
  --warning: #e67700;
  --warning-light: #fff9db;
  --danger: #c92a2a;
  --danger-light: #fff5f5;
  --text: #1a1d2e;
  --text2: #5c6080;
  --text3: #9da3c0;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.10);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Noto Sans JP', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 14px; }

/* Setup Banner */
#setupBanner {
  background: var(--warning-light);
  border-bottom: 2px solid var(--warning);
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
#setupBanner.connected { background: var(--success-light); border-color: var(--success); }
.banner-text { font-size: 12px; color: var(--warning); font-weight: 500; white-space: nowrap; }
#setupBanner.connected .banner-text { color: var(--success); }
#setupBanner input {
  flex: 1; min-width: 200px;
  background: white; border: 1px solid var(--border); border-radius: 8px;
  padding: 7px 12px; color: var(--text); font-size: 13px; outline: none;
}
#setupBanner input:focus { border-color: var(--accent); }
#syncStatus { font-size: 11px; padding: 3px 10px; border-radius: 20px; white-space: nowrap; font-weight: 600; }
.sync-ok { background: var(--success-light); color: var(--success); }
.sync-off { background: var(--warning-light); color: var(--warning); }
.sync-err { background: var(--danger-light); color: var(--danger); }
.sync-ing { background: var(--accent-light); color: var(--accent); animation: pulse 1s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

/* Header */
header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow);
  padding: 0 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  height: 52px;
  position: sticky;
  top: 0;
  z-index: 100;
}
.logo {
  font-family: 'DM Mono', monospace;
  font-size: 14px;
  font-weight: 500;
  color: var(--accent);
  letter-spacing: 1px;
  white-space: nowrap;
}
nav { display: flex; gap: 2px; flex: 1; overflow-x: auto; -webkit-overflow-scrolling: touch; }
nav::-webkit-scrollbar { display: none; }
.nav-btn {
  padding: 6px 12px; border-radius: 8px; border: none;
  background: transparent; color: var(--text2); cursor: pointer;
  font-family: 'Noto Sans JP', sans-serif; font-size: 12px;
  transition: all 0.15s; white-space: nowrap; font-weight: 500;
}
.nav-btn:hover { background: var(--surface2); color: var(--text); }
.nav-btn.active { background: var(--accent); color: #fff; }
.header-right { display: flex; align-items: center; gap: 8px; margin-left: auto; }
.badge-alert {
  background: var(--danger); color: white;
  font-size: 11px; font-weight: 700; border-radius: 10px; padding: 2px 8px;
}

/* Main */
main { flex: 1; padding: 16px; max-width: 1200px; margin: 0 auto; width: 100%; }
.view { display: none; }
.view.active { display: block; }

/* Stats - 3 cards (ç·åœ¨åº«æ•°ã‚’é™¤ã) */
.stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
.stat-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 16px; box-shadow: var(--shadow);
  position: relative; overflow: hidden;
}
.stat-card::after {
  content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px;
}
.stat-card.blue::after { background: var(--accent); }
.stat-card.green::after { background: var(--success); }
.stat-card.red::after { background: var(--danger); }
.stat-label { font-size: 11px; color: var(--text2); font-weight: 500; margin-bottom: 8px; }
.stat-value { font-family: 'DM Mono', monospace; font-size: 28px; font-weight: 500; }
.stat-value.blue { color: var(--accent); }
.stat-value.green { color: var(--success); }
.stat-value.red { color: var(--danger); }

/* Toolbar */
.toolbar { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; align-items: center; }
.search-box {
  flex: 1; min-width: 140px;
  background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
  padding: 8px 12px; color: var(--text); font-family: 'Noto Sans JP', sans-serif;
  font-size: 13px; outline: none; box-shadow: var(--shadow);
}
.search-box:focus { border-color: var(--accent); }
select {
  background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
  padding: 8px 10px; color: var(--text); font-family: 'Noto Sans JP', sans-serif;
  font-size: 13px; outline: none; cursor: pointer; box-shadow: var(--shadow);
}

/* Buttons */
.btn {
  padding: 8px 14px; border-radius: 8px; border: none;
  font-family: 'Noto Sans JP', sans-serif; font-size: 13px; font-weight: 500;
  cursor: pointer; transition: all 0.15s; white-space: nowrap;
}
.btn-primary { background: var(--accent); color: white; box-shadow: 0 2px 8px rgba(59,91,219,0.3); }
.btn-primary:hover { background: #2f4cc4; }
.btn-success { background: var(--success); color: white; }
.btn-success:hover { background: #237a33; }
.btn-danger { background: var(--danger); color: white; }
.btn-danger:hover { background: #a82020; }
.btn-ghost { background: var(--surface); color: var(--text2); border: 1px solid var(--border); box-shadow: var(--shadow); }
.btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
.btn-sm { padding: 5px 10px; font-size: 12px; border-radius: 6px; }

/* Table */
.table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: auto; box-shadow: var(--shadow); }
table { width: 100%; border-collapse: collapse; min-width: 560px; }
th {
  background: var(--surface2); padding: 10px 14px;
  text-align: left; font-size: 11px; color: var(--text2);
  text-transform: uppercase; letter-spacing: 0.8px; font-weight: 600;
  border-bottom: 1px solid var(--border); white-space: nowrap;
}
td { padding: 11px 14px; border-bottom: 1px solid var(--border); vertical-align: middle; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: var(--accent-light); }
.stock-num { font-family: 'DM Mono', monospace; font-size: 16px; font-weight: 500; }
.stock-num.ok { color: var(--success); }
.stock-num.low { color: var(--warning); }
.stock-num.critical { color: var(--danger); }
.cat-tag { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 11px; background: var(--accent-light); color: var(--accent); font-weight: 500; }
.alert-tag { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 10px; background: var(--danger-light); color: var(--danger); font-weight: 700; }
.qty-input {
  width: 54px; text-align: center;
  background: var(--surface2); border: 1px solid var(--border); border-radius: 6px;
  padding: 5px 4px; color: var(--text); font-size: 13px; outline: none;
}
.qty-input:focus { border-color: var(--accent); }
.action-btns { display: flex; gap: 4px; }

/* Modal */
.modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.4); z-index: 200;
  align-items: center; justify-content: center;
  backdrop-filter: blur(4px); padding: 16px;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 16px; padding: 24px; width: 100%; max-width: 440px;
  max-height: 90vh; overflow-y: auto;
  box-shadow: var(--shadow-md);
  animation: slideUp 0.2s ease;
}
@keyframes slideUp { from{transform:translateY(12px);opacity:0} to{transform:translateY(0);opacity:1} }
.modal h2 { font-size: 17px; margin-bottom: 18px; color: var(--text); }
.form-group { margin-bottom: 14px; }
label { display: block; font-size: 11px; color: var(--text2); margin-bottom: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
input[type=text], input[type=number], select.form-select {
  width: 100%; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; padding: 9px 12px; color: var(--text);
  font-family: 'Noto Sans JP', sans-serif; font-size: 14px; outline: none;
}
input[type=text]:focus, input[type=number]:focus, select.form-select:focus { border-color: var(--accent); background: white; }
.modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }

/* History */
.history-filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; align-items: center; }
.type-badge { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 4px; }
.type-badge.in { background: var(--success-light); color: var(--success); }
.type-badge.out { background: var(--danger-light); color: var(--danger); }
.type-badge.edit, .type-badge.add { background: var(--accent-light); color: var(--accent); }
.type-badge.delete { background: var(--warning-light); color: var(--warning); }

/* Summary - per item */
.summary-period-bar {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; padding: 12px 16px; margin-bottom: 16px;
  display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
  box-shadow: var(--shadow);
}
.period-label-text { font-family: 'DM Mono', monospace; font-size: 13px; color: var(--accent); font-weight: 500; }
.summary-table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: auto; box-shadow: var(--shadow); }
.summary-table-wrap table { min-width: 500px; }
.summary-table-wrap th { font-size: 11px; }
.in-val { color: var(--success); font-family: 'DM Mono', monospace; font-weight: 500; }
.out-val { color: var(--danger); font-family: 'DM Mono', monospace; font-weight: 500; }
.diff-pos { color: var(--success); font-family: 'DM Mono', monospace; font-weight: 500; }
.diff-neg { color: var(--danger); font-family: 'DM Mono', monospace; font-weight: 500; }
.cur-stock { font-family: 'DM Mono', monospace; font-weight: 500; }

/* Alerts */
.alerts-list { display: flex; flex-direction: column; gap: 10px; }
.alert-item {
  background: var(--danger-light); border: 1px solid #ffc9c9;
  border-radius: 10px; padding: 14px 16px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
}
.alert-item-name { font-weight: 600; margin-bottom: 4px; }
.alert-item-detail { font-size: 12px; color: var(--text2); }

/* Toast */
.toast-container { position: fixed; bottom: 20px; right: 16px; z-index: 300; display: flex; flex-direction: column; gap: 8px; }
.toast {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; padding: 10px 14px; font-size: 13px;
  min-width: 200px; max-width: 300px;
  box-shadow: var(--shadow-md);
  animation: toastIn 0.2s ease;
}
@keyframes toastIn { from{transform:translateX(20px);opacity:0} to{transform:translateX(0);opacity:1} }
.toast.success { border-left: 3px solid var(--success); }
.toast.error { border-left: 3px solid var(--danger); }
.toast.info { border-left: 3px solid var(--accent); }

/* Setup guide */
.setup-guide { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; box-shadow: var(--shadow); }
.setup-guide h2 { font-size: 16px; margin-bottom: 20px; color: var(--accent); }
.step { display: flex; gap: 14px; margin-bottom: 20px; }
.step-num { width: 30px; height: 30px; border-radius: 50%; background: var(--accent); color: white; font-family: 'DM Mono', monospace; font-weight: 500; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 13px; }
.step-content h3 { font-size: 14px; margin-bottom: 5px; }
.step-content p { font-size: 13px; color: var(--text2); line-height: 1.8; }
.code-box { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 9px 14px; font-family: 'DM Mono', monospace; font-size: 12px; color: var(--accent); margin-top: 8px; word-break: break-all; }
.hl { color: var(--danger); font-weight: 700; }

/* Category management */
.cat-manage-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
.cat-manage-item {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; padding: 12px 16px;
  display: flex; align-items: center; gap: 12px;
  box-shadow: var(--shadow);
}
.cat-icon-btn {
  width: 36px; height: 36px; border-radius: 50%; border: none;
  font-size: 18px; cursor: pointer; display: flex; align-items: center;
  justify-content: center; flex-shrink: 0; transition: transform 0.1s;
}
.cat-icon-btn:hover { transform: scale(1.1); }
.cat-name-input {
  flex: 1; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; padding: 7px 12px; font-family: 'Noto Sans JP', sans-serif;
  font-size: 13px; color: var(--text); outline: none;
}
.cat-name-input:focus { border-color: var(--accent); }
.drag-handle { cursor: grab; color: var(--text3); font-size: 18px; padding: 0 4px; user-select: none; }
.drag-handle:active { cursor: grabbing; }
.color-swatch {
  width: 24px; height: 24px; border-radius: 50%; border: 2px solid transparent;
  cursor: pointer; flex-shrink: 0; transition: all 0.1s;
}
.color-swatch.selected { border-color: var(--text); transform: scale(1.2); }
.color-picker-row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }

.empty-state { text-align: center; padding: 40px 20px; color: var(--text3); }

/* Mobile */
@media (max-width: 600px) {
  .stats-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .stat-value { font-size: 22px; }
  .stat-card { padding: 12px; }
  header { padding: 0 12px; }
  main { padding: 12px; }
  th, td { padding: 8px 10px; }
  .logo { font-size: 12px; }
}
</style>
</head>
<body>

<!-- Setup Banner -->
<div id="setupBanner">
  <span class="banner-text" id="bannerText">âš™ GAS URLã‚’è¨­å®šã—ã¦ãã ã•ã„</span>
  <input type="text" id="gasUrlInput" placeholder="https://script.google.com/macros/s/xxxx/exec" oninput="saveGasUrl()">
  <span id="syncStatus" class="sync-off">æœªæ¥ç¶š</span>
  <button class="btn btn-ghost btn-sm" onclick="showView('setup')">è¨­å®šæ–¹æ³•</button>
</div>

<header>
  <div class="logo">åœ¨åº«SYS</div>
  <nav>
    <button class="nav-btn active" onclick="showView('inventory')">ğŸ“¦ åœ¨åº«</button>
    <button class="nav-btn" onclick="showView('history')">ğŸ“‹ å±¥æ­´</button>
    <button class="nav-btn" onclick="showView('summary')">ğŸ“Š ã‚µãƒãƒªãƒ¼</button>
    <button class="nav-btn" onclick="showView('alerts')">ğŸ”” ã‚¢ãƒ©ãƒ¼ãƒˆ</button>
    <button class="nav-btn" onclick="showView('categories')">ğŸ· ã‚«ãƒ†ã‚´ãƒª</button>
    <button class="nav-btn" onclick="showView('setup')">âš™ è¨­å®š</button>
  </nav>
  <div class="header-right">
    <span id="alertBadge" class="badge-alert" style="display:none">âš  0</span>
    <button class="btn btn-ghost btn-sm" onclick="syncToSheets()">ğŸ”„ åŒæœŸ</button>
  </div>
</header>

<main>
  <!-- åœ¨åº«ä¸€è¦§ -->
  <div id="view-inventory" class="view active">
    <div class="stats-grid" id="statsGrid"></div>
    <div class="toolbar">
      <input class="search-box" type="text" placeholder="ğŸ” å•†å“åã§æ¤œç´¢..." id="searchBox" oninput="renderInventory()">
      <select id="filterCategory" onchange="renderInventory()"><option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option></select>
      <select id="filterStatus" onchange="renderInventory()">
        <option value="">å…¨çŠ¶æ…‹</option>
        <option value="ok">æ­£å¸¸</option>
        <option value="low">å°‘ãªã„</option>
        <option value="critical">å±é™º</option>
      </select>
      <button class="btn btn-primary" onclick="openAddModal()">ï¼‹ è¿½åŠ </button>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>å•†å“å</th>
            <th>ã‚«ãƒ†ã‚´ãƒª</th>
            <th>åœ¨åº«æ•°</th>
            <th>å˜ä½</th>
            <th>é–¾å€¤</th>
            <th>å…¥åº«</th>
            <th>å‡ºåº«</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="inventoryBody"></tbody>
      </table>
    </div>
  </div>

  <!-- å±¥æ­´ -->
  <div id="view-history" class="view">
    <div class="history-filters">
      <select id="historyMonth" onchange="renderHistory()"><option value="">å…¨æœˆ</option></select>
      <select id="historyType" onchange="renderHistory()">
        <option value="">å…¨ç¨®åˆ¥</option>
        <option value="in">å…¥åº«</option>
        <option value="out">å‡ºåº«</option>
        <option value="edit">ç·¨é›†</option>
        <option value="add">è¿½åŠ </option>
        <option value="delete">å‰Šé™¤</option>
      </select>
      <select id="historyItem" onchange="renderHistory()"><option value="">å…¨å•†å“</option></select>
      <select id="historyPerson" onchange="renderHistory()"><option value="">å…¨æ‹…å½“è€…</option></select>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>æ—¥æ™‚</th><th>ç¨®åˆ¥</th><th>æ‹…å½“è€…</th><th>å•†å“å</th><th>æ•°é‡</th><th>åœ¨åº«å¤‰åŒ–</th><th>å‚™è€ƒ</th></tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ã‚µãƒãƒªãƒ¼ï¼ˆã‚«ãƒ†ã‚´ãƒª â†’ å•†å“ï¼‰ -->
  <div id="view-summary" class="view">
    <div class="summary-period-bar">
      <span style="font-size:12px;color:var(--text2)">å¹´åº¦ï¼š</span>
      <select id="summaryYear" onchange="renderSummaryCategories()"></select>
      <span class="period-label-text" id="summaryPeriodLabel"></span>
    </div>

    <!-- Step1: ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ -->
    <div id="summaryCatView">
      <div style="font-size:13px;color:var(--text2);margin-bottom:12px;">ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„</div>
      <div id="summaryCatGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;"></div>
    </div>

    <!-- Step2: å•†å“ä¸€è¦§ -->
    <div id="summaryItemView" style="display:none;">
      <div style="margin-bottom:14px;display:flex;align-items:center;gap:10px;">
        <button class="btn btn-ghost btn-sm" onclick="backToCategories()">â† ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã«æˆ»ã‚‹</button>
        <span id="summaryItemCatLabel" style="font-weight:600;font-size:15px;"></span>
      </div>
      <div class="summary-table-wrap">
        <table>
          <thead>
            <tr>
              <th>å•†å“å</th>
              <th>ç¾åœ¨åº«</th>
              <th>å˜ä½</th>
              <th>æœŸé–“å…¥åº«</th>
              <th>æœŸé–“å‡ºåº«</th>
              <th>å·®å¼•</th>
              <th>çŠ¶æ…‹</th>
            </tr>
          </thead>
          <tbody id="summaryItemBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ã‚«ãƒ†ã‚´ãƒªç®¡ç† -->
  <div id="view-categories" class="view">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
      <h2 style="font-size:15px;font-weight:600;">ğŸ· ã‚«ãƒ†ã‚´ãƒªç®¡ç†</h2>
      <button class="btn btn-primary" onclick="addCategory()">ï¼‹ ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </button>
    </div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:var(--shadow);font-size:12px;color:var(--text2);">
      ğŸ’¡ ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆâ˜°ï¼‰ã§ä¸¦ã³æ›¿ãˆã€ã‚¢ã‚¤ã‚³ãƒ³ã¨è‰²ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚ã‚«ãƒ†ã‚´ãƒªåã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ãã®ã‚«ãƒ†ã‚´ãƒªã®å•†å“ã‚‚ä¸€æ‹¬ã§æ›´æ–°ã•ã‚Œã¾ã™ã€‚
    </div>
    <div class="cat-manage-list" id="catManageList"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button class="btn btn-primary" onclick="saveCategoryChanges()">âœ“ å¤‰æ›´ã‚’ä¿å­˜</button>
    </div>
  </div>

  <!-- ã‚¢ãƒ©ãƒ¼ãƒˆ -->
  <div id="view-alerts" class="view">
    <h2 style="margin-bottom:14px;font-size:15px;font-weight:600;">âš  åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ</h2>
    <div class="alerts-list" id="alertsList"></div>
  </div>

  <!-- è¨­å®š -->
  <div id="view-setup" class="view">
    <div class="setup-guide">
      <h2>ğŸ“‹ Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº è¨­å®šæ‰‹é †</h2>
      <div class="step">
        <div class="step-num">1</div>
        <div class="step-content">
          <h3>Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ–°è¦ä½œæˆ</h3>
          <p><a href="https://sheets.new" target="_blank" style="color:var(--accent)">sheets.new</a> ã‚’é–‹ã„ã¦æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œã‚Šã¾ã™ã€‚</p>
        </div>
      </div>
      <div class="step">
        <div class="step-num">2</div>
        <div class="step-content">
          <h3>Apps Scriptã‚’é–‹ã</h3>
          <p>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œæ‹¡å¼µæ©Ÿèƒ½ã€â†’ã€Œ<span class="hl">Apps Script</span>ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚</p>
        </div>
      </div>
      <div class="step">
        <div class="step-num">3</div>
        <div class="step-content">
          <h3>gas_code.gs ã®ä¸­èº«ã‚’è²¼ã‚Šä»˜ã‘ã¦ä¿å­˜</h3>
          <p>æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¨æ¶ˆã—ï¼ˆâŒ˜+A â†’ Deleteï¼‰ã—ã¦ã€gas_code.gs ã®å†…å®¹ã‚’è²¼ã‚Šä»˜ã‘ã€‚âŒ˜+S ã§ä¿å­˜ã€‚</p>
        </div>
      </div>
      <div class="step">
        <div class="step-num">4</div>
        <div class="step-content">
          <h3>Webã‚¢ãƒ—ãƒªã¨ã—ã¦å…¬é–‹</h3>
          <p>å³ä¸Šã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€â†’ã€Œæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã€â†’ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã€â†’ ã‚¢ã‚¯ã‚»ã‚¹ã‚’<span class="hl">ã€Œå…¨å“¡ã€</span>â†’ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€ã€‚</p>
          <p>è­¦å‘ŠãŒå‡ºãŸã‚‰ã€Œé«˜åº¦ãªã€â†’ã€Œã€‡ã€‡ã«ç§»å‹•ã€â†’ã€Œè¨±å¯ã€ã€‚</p>
        </div>
      </div>
      <div class="step">
        <div class="step-num">5</div>
        <div class="step-content">
          <h3>URLã‚’ã“ã®ã‚¢ãƒ—ãƒªã®ä¸Šéƒ¨ã«è²¼ã‚Šä»˜ã‘ã‚‹</h3>
          <div class="code-box">ä¾‹: https://script.google.com/macros/s/AKfy.../exec</div>
        </div>
      </div>
      <div style="background:var(--surface2);border-radius:10px;padding:14px;font-size:12px;color:var(--text2);margin-top:8px;">
        ğŸ’¡ URLã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã¨ã€Œâœ“ URLè¨­å®šæ¸ˆã¿ã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã‚ã¨ã¯åœ¨åº«ã‚’æ“ä½œã™ã‚‹ãŸã³ã«è‡ªå‹•åŒæœŸã•ã‚Œã¾ã™ã€‚
      </div>
    </div>
  </div>
</main>

<!-- Add/Edit Modal -->
<div class="modal-overlay" id="itemModal">
  <div class="modal">
    <h2 id="modalTitle">å•†å“è¿½åŠ </h2>
    <div class="form-group"><label>å•†å“å *</label><input type="text" id="f_name" placeholder="ä¾‹: ã‚³ãƒ”ãƒ¼ç”¨ç´™ A4"></div>
    <div class="form-group"><label>ã‚«ãƒ†ã‚´ãƒª</label><input type="text" id="f_category" placeholder="ä¾‹: æ–‡å…·ã€æ¶ˆè€—å“"></div>
    <div class="form-group"><label>ç¾åœ¨åº«æ•°</label><input type="number" id="f_stock" placeholder="0" min="0"></div>
    <div class="form-group"><label>å˜ä½</label><input type="text" id="f_unit" placeholder="ä¾‹: å€‹, æœ¬, ã‚»ãƒƒãƒˆ, ç®±"></div>
    <div class="form-group"><label>ã‚¢ãƒ©ãƒ¼ãƒˆé–¾å€¤ï¼ˆã“ã®æ•°ä»¥ä¸‹ã§è­¦å‘Šï¼‰</label><input type="number" id="f_alert" placeholder="ä¾‹: 10" min="0"></div>
    <div class="form-group"><label>å‚™è€ƒ</label><input type="text" id="f_note" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('itemModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveItem()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- Stock Modal (å…¥å‡ºåº«) -->
<div class="modal-overlay" id="stockModal">
  <div class="modal">
    <h2 id="stockModalTitle">å…¥åº«</h2>
    <div style="background:var(--surface2);border-radius:10px;padding:14px;margin-bottom:16px;">
      <div style="font-size:11px;color:var(--text2);margin-bottom:4px;">ç¾åœ¨åº«æ•°</div>
      <div style="font-family:'DM Mono',monospace;font-size:26px;font-weight:500;" id="currentStockDisp">0</div>
    </div>
    <div class="form-group"><label>æ‹…å½“è€…å *</label><input type="text" id="s_person" placeholder="ä¾‹: å±±ç”° å¤ªéƒ" list="personList"><datalist id="personList"></datalist></div>
    <div class="form-group"><label>æ•°é‡ *</label><input type="number" id="s_qty" placeholder="æ•°é‡ã‚’å…¥åŠ›" min="1"></div>
    <div class="form-group"><label>å‚™è€ƒ</label><input type="text" id="s_note" placeholder="ç†ç”±ãƒ»ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('stockModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" id="stockActionBtn" onclick="confirmStock()">ç¢ºå®š</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
// ===== STATE =====
let state = { items: [], history: [], nextId: 1 };
let editingId = null;
let stockAction = null;
// GAS URLï¼ˆåŸ‹ã‚è¾¼ã¿æ¸ˆã¿ - å¤‰æ›´ä¸è¦ï¼‰
const DEFAULT_GAS_URL = 'https://script.google.com/macros/s/AKfycbyjf-yFlzvvfCv3sg7KAaz7PmkpcYt8hJidPYhnSKoRFqVAbA8NyFQuYEzStkF8FJj_/exec';
let GAS_URL = DEFAULT_GAS_URL;

// ===== STORAGE =====
function saveLocal() { localStorage.setItem('inv_v3', JSON.stringify(state)); }
function loadLocal() {
  const d = localStorage.getItem('inv_v3');
  if (d) { try { state = JSON.parse(d); } catch(e) {} }
  if (!state.items) state.items = [];
  if (!state.history) state.history = [];
  if (!state.nextId) state.nextId = 1;
  // åŸ‹ã‚è¾¼ã¿URLã‚’å„ªå…ˆã€ãªã‘ã‚Œã°localStorageã‹ã‚‰
  GAS_URL = DEFAULT_GAS_URL || localStorage.getItem('gas_url') || '';
  if (GAS_URL) {
    document.getElementById('gasUrlInput').value = GAS_URL;
    setBannerConnected();
  }
}
function saveGasUrl() {
  GAS_URL = document.getElementById('gasUrlInput').value.trim();
  localStorage.setItem('gas_url', GAS_URL);
  if (GAS_URL) { setBannerConnected(); startAutoSync(); }
  else { document.getElementById('setupBanner').classList.remove('connected'); document.getElementById('bannerText').textContent = 'âš™ GAS URLã‚’è¨­å®šã—ã¦ãã ã•ã„'; }
}
function setBannerConnected() {
  document.getElementById('setupBanner').classList.add('connected');
  document.getElementById('bannerText').textContent = 'âœ“ URLè¨­å®šæ¸ˆã¿ â€” åœ¨åº«ã‚’å¤‰æ›´ã™ã‚‹ãŸã³ã«è‡ªå‹•åŒæœŸã•ã‚Œã¾ã™';
  updateSyncStatus('ok');
}

// ===== GAS =====
function updateSyncStatus(s) {
  const el = document.getElementById('syncStatus');
  const m = { ok:{cls:'sync-ok',t:'â— åŒæœŸæ¸ˆã¿'}, off:{cls:'sync-off',t:'â— æœªæ¥ç¶š'}, err:{cls:'sync-err',t:'â— ã‚¨ãƒ©ãƒ¼'}, ing:{cls:'sync-ing',t:'â— åŒæœŸä¸­...'} };
  const v = m[s] || m.off;
  el.className = v.cls; el.textContent = v.t;
}
async function gasPost(body) {
  if (!GAS_URL) return null;
  updateSyncStatus('ing');
  try {
    const res = await fetch(GAS_URL, { method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(body), redirect:'follow' });
    const text = await res.text();
    let json;
    try { json = JSON.parse(text); } catch(e) { json = {ok:true}; }
    // GASã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œã«HTMLã‚’è¿”ã™ã“ã¨ãŒã‚ã‚‹â†’ãƒ†ã‚­ã‚¹ãƒˆãŒè¿”ã£ã¦ããŸã‚‰æˆåŠŸã¨ã¿ãªã™
    if (!json || json.ok === undefined) json = {ok:true};
    updateSyncStatus(json.ok ? 'ok' : 'err');
    return json;
  } catch(e) {
    // CORSã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯no-corsã§å†è©¦è¡Œï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹èª­ã‚ãªã„ãŒé€ä¿¡ã¯æˆåŠŸï¼‰
    try {
      await fetch(GAS_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(body) });
      // no-corsã¯å¸¸ã«opaque responseãªã®ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹èª­ã‚ãªã„ãŒé€ä¿¡æˆåŠŸã¨ã¿ãªã™
      updateSyncStatus('ok');
      return {ok:true};
    } catch(e2) {
      updateSyncStatus('err');
      return null;
    }
  }
}
async function loadFromSheets() {
  if (!GAS_URL) return;
  updateSyncStatus('ing');
  try {
    const res = await fetch(GAS_URL + '?action=loadAll', { redirect: 'follow' });
    const text = await res.text();
    let json; try { json = JSON.parse(text); } catch(e) { json = null; }
    if (json && json.ok && json.items) {
      state.items   = json.items;
      state.history = json.history || [];
      state.nextId  = json.nextId  || 1;
      saveLocal();
      renderStats(); renderInventory();
      updateSyncStatus('ok');
      return true;
    }
  } catch(e) {}
  updateSyncStatus('err');
  return false;
}
async function syncToSheets() {
  if (!GAS_URL) { toast('GASã®URLã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error'); showView('setup'); return; }
  toast('ğŸ”„ åŒæœŸä¸­...', 'info');
  // ã¾ãšæ›¸ãè¾¼ã¿ï¼ˆè‡ªåˆ†ã®å¤‰æ›´ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ï¼‰
  await gasPost({ action:'syncAll', items:state.items });
  // æ¬¡ã«èª­ã¿è¾¼ã¿ï¼ˆä»–ã®äººã®å¤‰æ›´ã‚’å–å¾—ï¼‰
  const loaded = await loadFromSheets();
  if (loaded) toast('âœ… åŒæœŸå®Œäº†ï¼æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ', 'success');
  else toast('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«åŒæœŸã—ã¾ã—ãŸ', 'success');
}

// ===== VIEWS =====
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('view-' + name)?.classList.add('active');
  const idx = {inventory:0,history:1,summary:2,alerts:3,categories:4,setup:5};
  if (idx[name] !== undefined) document.querySelectorAll('.nav-btn')[idx[name]]?.classList.add('active');
  if (name==='inventory') { renderStats(); renderInventory(); }
  if (name==='history') renderHistory();
  if (name==='summary') renderSummary();
  if (name==='alerts') renderAlerts();
  if (name==='categories') renderCategoryManager();
}

// ===== CATEGORY MANAGEMENT =====
const CAT_ICONS = ['ğŸ“¦','ğŸ“','ğŸ—‚','ğŸ§¹','â˜•','ğŸ–Š','ğŸ’Š','ğŸ”§','ğŸ±','ğŸ“„','ğŸ§´','ğŸ–¨','ğŸ“‹','ğŸ·','ğŸ’¡','ğŸ'];
const CAT_COLORS = ['#3b5bdb','#2f9e44','#e67700','#c92a2a','#7c5cfc','#0c8599','#e64980','#5c7cfa','#f76707','#37b24d'];

let catEdits = []; // ç·¨é›†ä¸­ã®ã‚«ãƒ†ã‚´ãƒªãƒ‡ãƒ¼ã‚¿

function renderCategoryManager() {
  // ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’å–å¾—
  const cats = [...new Set(state.items.map(i => i.category||'æœªåˆ†é¡'))].sort();
  // state.categoriesãŒãªã‘ã‚Œã°åˆæœŸåŒ–
  if (!state.categories) {
    state.categories = cats.map((name, i) => ({
      name, icon: CAT_ICONS[i % CAT_ICONS.length], color: CAT_COLORS[i % CAT_COLORS.length], originalName: name
    }));
  }
  // æ—¢å­˜ã‚«ãƒ†ã‚´ãƒªã§ç™»éŒ²ã•ã‚Œã¦ã„ãªã„ã‚‚ã®ã‚’è¿½åŠ 
  cats.forEach(cat => {
    if (!state.categories.find(c => c.name === cat)) {
      state.categories.push({ name: cat, icon: 'ğŸ“¦', color: CAT_COLORS[0], originalName: cat });
    }
  });
  catEdits = state.categories.map(c => ({...c}));
  renderCatList();
}

function renderCatList() {
  const list = document.getElementById('catManageList');
  if (!catEdits.length) {
    list.innerHTML = `<div class="empty-state"><p>ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“ã€‚å•†å“ã‚’è¿½åŠ ã™ã‚‹ã¨ã‚«ãƒ†ã‚´ãƒªãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã™ã€‚</p></div>`;
    return;
  }
  list.innerHTML = catEdits.map((cat, idx) => {
    const itemCount = state.items.filter(i => (i.category||'æœªåˆ†é¡') === cat.originalName).length;
    return `<div class="cat-manage-item" draggable="true" data-idx="${idx}"
      ondragstart="dragStart(event,${idx})" ondragover="dragOver(event)" ondrop="dropCat(event,${idx})">
      <span class="drag-handle" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ">â˜°</span>
      <button class="cat-icon-btn" style="background:${cat.color}20;font-size:20px;"
        onclick="openIconPicker(${idx})">${cat.icon}</button>
      <input class="cat-name-input" value="${esc(cat.name)}" oninput="catEdits[${idx}].name=this.value" placeholder="ã‚«ãƒ†ã‚´ãƒªå">
      <span style="font-size:11px;color:var(--text2);white-space:nowrap;">${itemCount}å“</span>
      <div style="display:flex;gap:4px;">
        ${CAT_COLORS.slice(0,6).map(c => `<div class="color-swatch ${cat.color===c?'selected':''}" style="background:${c}" onclick="setCatColor(${idx},'${c}')"></div>`).join('')}
      </div>
      <button class="btn btn-danger btn-sm" onclick="removeCategory(${idx})" title="å‰Šé™¤">ğŸ—‘</button>
    </div>`;
  }).join('');
}

function openIconPicker(idx) {
  const picked = prompt('ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆçµµæ–‡å­—ã‚’å…¥åŠ›ï¼‰:\n' + CAT_ICONS.join(' '), catEdits[idx].icon);
  if (picked) { catEdits[idx].icon = picked.trim(); renderCatList(); }
}

function setCatColor(idx, color) {
  catEdits[idx].color = color;
  renderCatList();
}

function addCategory() {
  const name = prompt('æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
  if (!name || !name.trim()) return;
  catEdits.push({ name: name.trim(), icon: 'ğŸ“¦', color: CAT_COLORS[catEdits.length % CAT_COLORS.length], originalName: '' });
  renderCatList();
}

function removeCategory(idx) {
  const cat = catEdits[idx];
  const count = state.items.filter(i => (i.category||'æœªåˆ†é¡') === cat.originalName).length;
  const msg = count > 0 ? `ã€Œ${cat.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆ${count}å“ç›®ã®å•†å“ãŒã€Œæœªåˆ†é¡ã€ã«ãªã‚Šã¾ã™ï¼‰` : `ã€Œ${cat.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
  if (!confirm(msg)) return;
  catEdits.splice(idx, 1);
  renderCatList();
}

async function saveCategoryChanges() {
  // åå‰å¤‰æ›´ã‚’å•†å“ã«åæ˜ 
  catEdits.forEach(cat => {
    if (cat.originalName && cat.originalName !== cat.name) {
      state.items.forEach(item => {
        if ((item.category||'æœªåˆ†é¡') === cat.originalName) item.category = cat.name;
      });
    }
    if (!cat.originalName) {
      // æ–°è¦ã‚«ãƒ†ã‚´ãƒªã¯åå‰ã ã‘ç™»éŒ²ï¼ˆå•†å“ã¯ã¾ã ãªã„ï¼‰
    }
    cat.originalName = cat.name;
  });
  // å‰Šé™¤ã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã®å•†å“ã‚’æœªåˆ†é¡ã«
  const validNames = catEdits.map(c => c.name);
  state.items.forEach(item => {
    if (item.category && !validNames.includes(item.category)) item.category = 'æœªåˆ†é¡';
  });
  state.categories = catEdits.map(c => ({...c}));
  saveLocal();
  renderStats(); renderInventory();
  toast('âœ… ã‚«ãƒ†ã‚´ãƒªã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
  await syncToSheets();
}

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ä¸¦ã³æ›¿ãˆ
let dragSrcIdx = null;
function dragStart(e, idx) { dragSrcIdx = idx; e.dataTransfer.effectAllowed = 'move'; }
function dragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
function dropCat(e, idx) {
  e.preventDefault();
  if (dragSrcIdx === null || dragSrcIdx === idx) return;
  const moved = catEdits.splice(dragSrcIdx, 1)[0];
  catEdits.splice(idx, 0, moved);
  dragSrcIdx = null;
  renderCatList();
}

// ===== STATS =====
function renderStats() {
  const total = state.items.length;
  const alerts = state.items.filter(i => i.alertThreshold != null && i.stock <= i.alertThreshold).length;
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card blue"><div class="stat-label">ç™»éŒ²å•†å“æ•°</div><div class="stat-value blue">${total}</div></div>
    <div class="stat-card red"><div class="stat-label">ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆé–¾å€¤ä»¥ä¸‹ï¼‰</div><div class="stat-value red">${alerts}</div></div>
  `;
  const badge = document.getElementById('alertBadge');
  badge.style.display = alerts > 0 ? '' : 'none';
  badge.textContent = `âš  ${alerts}`;
}
function getStockStatus(item) {
  if (item.alertThreshold == null) return 'ok';
  if (item.stock <= item.alertThreshold) return 'critical';
  return 'ok';
}

// ===== INVENTORY =====
function renderInventory() {
  const search = document.getElementById('searchBox').value.toLowerCase();
  const cat = document.getElementById('filterCategory').value;
  const status = document.getElementById('filterStatus').value;
  const cats = [...new Set(state.items.map(i=>i.category).filter(Boolean))].sort();
  const catSel = document.getElementById('filterCategory');
  const curCat = catSel.value;
  catSel.innerHTML = '<option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option>' + cats.map(c=>`<option value="${c}" ${c===curCat?'selected':''}>${esc(c)}</option>`).join('');
  const filtered = state.items.filter(i => {
    if (search && !i.name.toLowerCase().includes(search)) return false;
    if (cat && i.category !== cat) return false;
    if (status && getStockStatus(i) !== status) return false;
    return true;
  });
  const tbody = document.getElementById('inventoryBody');
  if (!filtered.length) { tbody.innerHTML=`<tr><td colspan="8"><div class="empty-state"><p>å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œï¼‹ è¿½åŠ ã€ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p></div></td></tr>`; return; }
  tbody.innerHTML = filtered.map(item => {
    const st = getStockStatus(item);
    const cls = st==='ok'?'ok':st==='low'?'low':'critical';
    return `<tr>
      <td><strong>${esc(item.name)}</strong>${item.note?`<div style="font-size:11px;color:var(--text2)">${esc(item.note)}</div>`:''}</td>
      <td>${item.category?`<span class="cat-tag">${esc(item.category)}</span>`:'<span style="color:var(--text3)">â€”</span>'}</td>
      <td><span class="stock-num ${cls}">${item.stock}</span>${st==='critical'?` <span class="alert-tag">LOW</span>`:''}</td>
      <td style="color:var(--text2)">${esc(item.unit||'å€‹')}</td>
      <td style="color:var(--text2)">${item.alertThreshold??'â€”'}</td>
      <td><div style="display:flex;align-items:center;gap:4px"><input type="number" min="1" class="qty-input" id="in_${item.id}" placeholder="æ•°"><button class="btn btn-success btn-sm" onclick="openStockModal(${item.id},'in')">å…¥åº«</button></div></td>
      <td><div style="display:flex;align-items:center;gap:4px"><input type="number" min="1" class="qty-input" id="out_${item.id}" placeholder="æ•°"><button class="btn btn-danger btn-sm" onclick="openStockModal(${item.id},'out')">å‡ºåº«</button></div></td>
      <td><div class="action-btns"><button class="btn btn-ghost btn-sm" onclick="openEditModal(${item.id})">âœ</button><button class="btn btn-danger btn-sm" onclick="deleteItem(${item.id})">ğŸ—‘</button></div></td>
    </tr>`;
  }).join('');
}

// ===== STOCK MODAL =====
function openStockModal(id, type) {
  const item = state.items.find(i=>i.id===id);
  if (!item) return;
  const qtyEl = document.getElementById((type==='in'?'in_':'out_') + id);
  const preQty = parseInt(qtyEl?.value) || null;
  stockAction = { id, type, preQty };
  document.getElementById('stockModalTitle').textContent = type==='in' ? `ğŸ“¥ å…¥åº«: ${item.name}` : `ğŸ“¤ å‡ºåº«: ${item.name}`;
  document.getElementById('currentStockDisp').textContent = item.stock;
  document.getElementById('s_qty').value = preQty || '';
  document.getElementById('s_note').value = '';
  document.getElementById('s_person').value = localStorage.getItem('last_person') || '';
  // æ‹…å½“è€…å€™è£œ
  const persons = [...new Set(state.history.filter(h=>h.person).map(h=>h.person))];
  document.getElementById('personList').innerHTML = persons.map(p=>`<option value="${esc(p)}">`).join('');
  document.getElementById('stockActionBtn').textContent = type==='in'?'å…¥åº«ç¢ºå®š':'å‡ºåº«ç¢ºå®š';
  document.getElementById('stockActionBtn').className = `btn ${type==='in'?'btn-success':'btn-danger'}`;
  document.getElementById('stockModal').classList.add('open');
}
async function confirmStock() {
  if (!stockAction) return;
  const {id, type} = stockAction;
  const item = state.items.find(i=>i.id===id);
  if (!item) return;
  const person = document.getElementById('s_person').value.trim();
  const qty = parseInt(document.getElementById('s_qty').value);
  const note = document.getElementById('s_note').value.trim();
  if (!person) { toast('æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
  if (!qty || qty <= 0) { toast('æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }

  closeModal('stockModal');
  const inp = document.getElementById((type==='in'?'in_':'out_')+id);
  if (inp) inp.value = '';

  if (GAS_URL) {
    // GASå´ã§ã‚¢ãƒˆãƒŸãƒƒã‚¯ã«æœ€æ–°åœ¨åº«ã‚’å–å¾—ã—ã¦æ›´æ–°
    toast('å‡¦ç†ä¸­...', 'info');
    try {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        headers: {'Content-Type': 'text/plain'},
        body: JSON.stringify({
          action: 'stockUpdate',
          itemId: id,
          itemName: item.name,
          type, qty, person, note,
          alertThreshold: item.alertThreshold
        }),
        redirect: 'follow'
      });
      const text = await res.text();
      let json; try { json = JSON.parse(text); } catch(e) { json = null; }

      if (json && json.ok) {
        // GASã‹ã‚‰è¿”ã£ã¦ããŸæœ€æ–°åœ¨åº«ã§ãƒ­ãƒ¼ã‚«ãƒ«ã‚’æ›´æ–°
        const before = item.stock;
        item.stock = json.newStock;
        const h = {type, itemId:id, itemName:item.name, qty, before: json.latestStock, after: json.newStock, note, person, date:new Date().toISOString(), id:Date.now()};
        state.history.unshift(h);
        saveLocal();
        renderStats(); renderInventory();
        toast(type==='in'?`âœ… å…¥åº«: +${qty} ${item.unit||'å€‹'} (${person})`:`ğŸ“¤ å‡ºåº«: -${qty} ${item.unit||'å€‹'} (${person})`, 'success');
        return;
      } else if (json && !json.ok) {
        toast(`âš  ${json.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'}`, 'error');
        return;
      }
    } catch(e) {}
  }

  // GASãªã— or å¤±æ•—æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§å‡¦ç†
  if (type==='out' && item.stock < qty) { toast('åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'error'); return; }
  const before = item.stock;
  item.stock += type==='in' ? qty : -qty;
  const h = {type, itemId:id, itemName:item.name, qty, before, after:item.stock, note, person, date:new Date().toISOString(), id:Date.now()};
  state.history.unshift(h);
  saveLocal();
  renderStats(); renderInventory();
  toast(type==='in'?`âœ… å…¥åº«: +${qty} ${item.unit||'å€‹'} (${person})`:`ğŸ“¤ å‡ºåº«: -${qty} ${item.unit||'å€‹'} (${person})`, 'success');
}

// ===== ITEM MODAL =====
function openAddModal() {
  editingId = null;
  document.getElementById('modalTitle').textContent = 'å•†å“è¿½åŠ ';
  ['name','category','unit','alert','note'].forEach(f => document.getElementById('f_'+f).value='');
  document.getElementById('f_stock').value='0';
  document.getElementById('itemModal').classList.add('open');
}
async function openEditModal(id) {
  const item = state.items.find(i=>i.id===id);
  if (!item) return;
  editingId = id;
  document.getElementById('modalTitle').textContent = 'å•†å“ç·¨é›†';
  document.getElementById('f_name').value = item.name;
  document.getElementById('f_category').value = item.category||'';
  document.getElementById('f_unit').value = item.unit||'';
  document.getElementById('f_alert').value = item.alertThreshold??'';
  document.getElementById('f_note').value = item.note||'';

  // GASã‹ã‚‰æœ€æ–°åœ¨åº«ã‚’å–å¾—ã—ã¦ã‚»ãƒƒãƒˆ
  let latestStock = item.stock;
  if (GAS_URL) {
    try {
      const res = await fetch(GAS_URL + '?action=loadAll', { redirect: 'follow' });
      const text = await res.text();
      const json = JSON.parse(text);
      if (json && json.ok && json.items) {
        const latest = json.items.find(i => i.id === id);
        if (latest) {
          latestStock = latest.stock;
          item.stock = latestStock; // ãƒ­ãƒ¼ã‚«ãƒ«ã‚‚æ›´æ–°
          saveLocal();
        }
      }
    } catch(e) {}
  }
  document.getElementById('f_stock').value = latestStock;
  document.getElementById('itemModal').classList.add('open');
}
async function saveItem() {
  const name = document.getElementById('f_name').value.trim();
  if (!name) { toast('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
  const stock = parseInt(document.getElementById('f_stock').value)||0;
  const alertV = document.getElementById('f_alert').value;
  const data = { name, category:document.getElementById('f_category').value.trim(), stock, unit:document.getElementById('f_unit').value.trim()||'å€‹', alertThreshold:alertV!==''?parseInt(alertV):null, note:document.getElementById('f_note').value.trim() };
  if (editingId) {
    const item = state.items.find(i=>i.id===editingId);
    const before = item.stock;
    Object.assign(item, data);
    const h = {type:'edit',itemId:editingId,itemName:name,qty:null,before,after:stock,note:'ç·¨é›†',person:'ã‚·ã‚¹ãƒ†ãƒ ',date:new Date().toISOString(),id:Date.now()};
    state.history.unshift(h);
    toast('âœ… æ›´æ–°ã—ã¾ã—ãŸ','success');
    saveLocal(); closeModal('itemModal'); renderStats(); renderInventory();
    await gasPost({action:'saveItem',...item});
    await gasPost({action:'addHistory',...h});
  } else {
    const newItem = {id:state.nextId++, ...data};
    state.items.push(newItem);
    const h = {type:'add',itemId:newItem.id,itemName:name,qty:stock,before:0,after:stock,note:'æ–°è¦è¿½åŠ ',person:'ã‚·ã‚¹ãƒ†ãƒ ',date:new Date().toISOString(),id:Date.now()};
    state.history.unshift(h);
    toast('âœ… å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸ','success');
    saveLocal(); closeModal('itemModal'); renderStats(); renderInventory();
    await gasPost({action:'saveItem',...newItem});
    await gasPost({action:'addHistory',...h});
  }
}
async function deleteItem(id) {
  const item = state.items.find(i=>i.id===id);
  if (!item || !confirm(`ã€Œ${item.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  state.items = state.items.filter(i=>i.id!==id);
  const h = {type:'delete',itemId:id,itemName:item.name,qty:null,before:item.stock,after:0,note:'å‰Šé™¤',person:'ã‚·ã‚¹ãƒ†ãƒ ',date:new Date().toISOString(),id:Date.now()};
  state.history.unshift(h);
  saveLocal(); renderStats(); renderInventory();
  toast('å‰Šé™¤ã—ã¾ã—ãŸ','info');
  await gasPost({action:'deleteItem',id});
  await gasPost({action:'addHistory',...h});
}
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ===== HISTORY =====
function renderHistory() {
  const year = getPeriodYear(new Date());
  const months = [];
  for (let m=6;m<=12;m++) months.push({y:year,m});
  for (let m=1;m<=5;m++) months.push({y:year+1,m});
  const monthSel = document.getElementById('historyMonth');
  const curM = monthSel.value;
  monthSel.innerHTML = '<option value="">å…¨æœˆ</option>' + months.map(({y,m})=>{const v=`${y}-${String(m).padStart(2,'0')}`; return `<option value="${v}" ${v===curM?'selected':''}>${y}å¹´${m}æœˆ</option>`;}).join('');
  const itemSel = document.getElementById('historyItem');
  const curI = itemSel.value;
  const names = [...new Set(state.history.map(h=>h.itemName))].sort();
  itemSel.innerHTML = '<option value="">å…¨å•†å“</option>' + names.map(n=>`<option value="${n}" ${n===curI?'selected':''}>${esc(n)}</option>`).join('');
  const personSel = document.getElementById('historyPerson');
  const curP = personSel.value;
  const persons = [...new Set(state.history.filter(h=>h.person && h.person!=='ã‚·ã‚¹ãƒ†ãƒ ').map(h=>h.person))].sort();
  personSel.innerHTML = '<option value="">å…¨æ‹…å½“è€…</option>' + persons.map(p=>`<option value="${p}" ${p===curP?'selected':''}>${esc(p)}</option>`).join('');

  const mf=document.getElementById('historyMonth').value;
  const tf=document.getElementById('historyType').value;
  const inf=document.getElementById('historyItem').value;
  const pf=document.getElementById('historyPerson').value;
  const filtered = state.history.filter(h=>{
    const d=new Date(h.date), ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    if (mf && ym!==mf) return false;
    if (tf && h.type!==tf) return false;
    if (inf && h.itemName!==inf) return false;
    if (pf && h.person!==pf) return false;
    return true;
  });
  const typeL={in:'å…¥åº«',out:'å‡ºåº«',edit:'ç·¨é›†',add:'è¿½åŠ ',delete:'å‰Šé™¤'};
  const typeC={in:'in',out:'out',edit:'edit',add:'add',delete:'delete'};
  const tbody=document.getElementById('historyBody');
  if (!filtered.length) { tbody.innerHTML=`<tr><td colspan="7"><div class="empty-state"><p>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p></div></td></tr>`; return; }
  tbody.innerHTML = filtered.map(h=>{
    const d=new Date(h.date);
    const ds=`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    const change=h.after-h.before;
    const cs=change>0?`<span style="color:var(--success)">+${change}</span>`:change<0?`<span style="color:var(--danger)">${change}</span>`:'â€”';
    return `<tr>
      <td style="font-size:12px;color:var(--text2);white-space:nowrap">${ds}</td>
      <td><span class="type-badge ${typeC[h.type]||'edit'}">${typeL[h.type]||h.type}</span></td>
      <td style="font-weight:500">${esc(h.person||'â€”')}</td>
      <td>${esc(h.itemName)}</td>
      <td style="font-family:'DM Mono',monospace">${h.qty!=null?h.qty:'â€”'}</td>
      <td style="font-family:'DM Mono',monospace;font-size:12px"><span style="color:var(--text3)">${h.before}</span>â†’<strong>${h.after}</strong> ${cs}</td>
      <td style="color:var(--text2);font-size:12px">${esc(h.note||'')}</td>
    </tr>`;
  }).join('');
}

// ===== SUMMARY (ã‚«ãƒ†ã‚´ãƒª â†’ å•†å“ 2æ®µéš) =====
let summaryPeriodHistory = [];

function renderSummary() { renderSummaryCategories(); }

function renderSummaryCategories() {
  const yearSel = document.getElementById('summaryYear');
  const years = getPeriodYears();
  const curY = parseInt(yearSel.value) || getPeriodYear(new Date());
  yearSel.innerHTML = years.map(y=>`<option value="${y}" ${y===curY?'selected':''}>${kiLabel(y)}ï¼ˆ${y}å¹´åº¦ï¼‰</option>`).join('');
  const year = parseInt(yearSel.value) || curY;
  document.getElementById('summaryPeriodLabel').textContent = `${year}å¹´6æœˆ ã€œ ${year+1}å¹´5æœˆ`;
  const range = getPeriodRange(year);
  summaryPeriodHistory = state.history.filter(h=>{ const d=new Date(h.date); return d>=range.start && d<=range.end; });

  // ã‚«ãƒ†ã‚´ãƒªä¸€è¦§è¡¨ç¤º
  document.getElementById('summaryCatView').style.display='';
  document.getElementById('summaryItemView').style.display='none';

  const cats = [...new Set(state.items.map(i=>i.category||'æœªåˆ†é¡'))].sort();
  const grid = document.getElementById('summaryCatGrid');
  if (!cats.length) { grid.innerHTML='<p style="color:var(--text2)">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</p>'; return; }

  grid.innerHTML = cats.map(cat => {
    const catDef = (state.categories||[]).find(c=>c.name===cat) || {icon:'ğŸ“¦', color:'#3b5bdb'};
    const catItems = state.items.filter(i=>(i.category||'æœªåˆ†é¡')===cat);
    const alertCount = catItems.filter(i=>getStockStatus(i)==='critical').length;
    const lowCount = catItems.filter(i=>getStockStatus(i)==='low').length;
    const ph = summaryPeriodHistory;
    const ids = catItems.map(i=>i.id);
    const names = catItems.map(i=>i.name);
    const inQ = ph.filter(h=>(ids.includes(h.itemId)||names.includes(h.itemName))&&h.type==='in').reduce((s,h)=>s+(h.qty||0),0);
    const outQ = ph.filter(h=>(ids.includes(h.itemId)||names.includes(h.itemName))&&h.type==='out').reduce((s,h)=>s+(h.qty||0),0);
    const alertBadge = alertCount>0 ? `<span class="alert-tag" style="margin-left:6px">âš  ${alertCount}</span>` : lowCount>0 ? `<span style="color:var(--warning);font-size:11px;font-weight:700;margin-left:6px">â–³ ${lowCount}</span>` : '';
    return `<div onclick="showSummaryItems('${esc(cat)}')" style="background:var(--surface);border:2px solid ${catDef.color}30;border-radius:12px;padding:18px;cursor:pointer;box-shadow:var(--shadow);transition:all 0.15s;" onmouseover="this.style.borderColor='${catDef.color}';this.style.boxShadow='var(--shadow-md)'" onmouseout="this.style.borderColor='${catDef.color}30';this.style.boxShadow='var(--shadow)'">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
        <span style="font-size:24px;">${catDef.icon}</span>
        <span style="font-weight:600;font-size:14px;">${esc(cat)}</span>${alertBadge}
      </div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:10px;">${catItems.length}å“ç›®</div>
      <div style="display:flex;gap:12px;font-size:12px;">
        <span style="color:var(--success);">â–² ${inQ}</span>
        <span style="color:var(--danger);">â–¼ ${outQ}</span>
        <span style="color:${inQ-outQ>=0?'var(--success)':'var(--danger)'};">${inQ-outQ>=0?'+':''}${inQ-outQ}</span>
      </div>
      <div style="text-align:right;margin-top:8px;font-size:11px;color:${catDef.color};font-weight:500;">è©³ç´°ã‚’è¦‹ã‚‹ â†’</div>
    </div>`;
  }).join('');
}

function showSummaryItems(cat) {
  document.getElementById('summaryCatView').style.display='none';
  document.getElementById('summaryItemView').style.display='';
  document.getElementById('summaryItemCatLabel').innerHTML = `<span class="cat-tag">${esc(cat)}</span> ã®å•†å“ä¸€è¦§`;

  const catItems = state.items.filter(i=>(i.category||'æœªåˆ†é¡')===cat);
  const ph = summaryPeriodHistory;
  const tbody = document.getElementById('summaryItemBody');
  if (!catItems.length) { tbody.innerHTML=`<tr><td colspan="7"><div class="empty-state"><p>å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</p></div></td></tr>`; return; }

  tbody.innerHTML = catItems.map(item => {
    const ih = ph.filter(h=>h.itemId===item.id||h.itemName===item.name);
    const inQ = ih.filter(h=>h.type==='in').reduce((s,h)=>s+(h.qty||0),0);
    const outQ = ih.filter(h=>h.type==='out').reduce((s,h)=>s+(h.qty||0),0);
    const diff = inQ - outQ;
    const st = getStockStatus(item);
    const stLabel = st==='critical'?`<span class="alert-tag">âš  å±é™º</span>`:st==='low'?`<span style="color:var(--warning);font-size:12px;font-weight:600;">â–³ å°‘ãªã„</span>`:`<span style="color:var(--success);font-size:12px;">âœ“ æ­£å¸¸</span>`;
    return `<tr>
      <td><strong>${esc(item.name)}</strong></td>
      <td><span class="cur-stock" style="color:${st==='critical'?'var(--danger)':st==='low'?'var(--warning)':'var(--success)'}">${item.stock}</span></td>
      <td style="color:var(--text2)">${esc(item.unit||'å€‹')}</td>
      <td><span class="in-val">+${inQ}</span></td>
      <td><span class="out-val">-${outQ}</span></td>
      <td><span class="${diff>=0?'diff-pos':'diff-neg'}">${diff>=0?'+':''}${diff}</span></td>
      <td>${stLabel}</td>
    </tr>`;
  }).join('');
}

function backToCategories() {
  document.getElementById('summaryCatView').style.display='';
  document.getElementById('summaryItemView').style.display='none';
}

// ===== ALERTS =====
function renderAlerts() {
  const items = state.items.filter(i=>i.alertThreshold!=null && i.stock<=i.alertThreshold);
  const list = document.getElementById('alertsList');
  if (!items.length) { list.innerHTML=`<div style="text-align:center;padding:48px;color:var(--text2)"><div style="font-size:48px;margin-bottom:12px">âœ…</div><p>ã‚¢ãƒ©ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã™ã¹ã¦æ­£å¸¸ã§ã™ã€‚</p></div>`; return; }
  list.innerHTML = items.map(item=>`<div class="alert-item">
    <div>
      <div class="alert-item-name">${esc(item.name)} ${item.category?`<span class="cat-tag">${esc(item.category)}</span>`:''}</div>
      <div class="alert-item-detail">ç¾åœ¨åº«: <strong style="color:var(--danger)">${item.stock} ${esc(item.unit||'å€‹')}</strong> ï¼ é–¾å€¤: ${item.alertThreshold} ä»¥ä¸‹</div>
    </div>
    <div style="text-align:right">
      <div style="font-family:'DM Mono',monospace;font-size:28px;font-weight:500;color:var(--danger)">${item.stock}</div>
      <div style="font-size:11px;color:var(--text2)">${esc(item.unit||'å€‹')}</div>
    </div>
  </div>`).join('');
}

// ===== UTILS =====
function getPeriodYear(d) { const m=d.getMonth()+1; return m>=6?d.getFullYear():d.getFullYear()-1; }
function getPeriodRange(y) { return {start:new Date(y,5,1), end:new Date(y+1,4,31,23,59,59)}; }
function getPeriodYears() { const s=new Set([getPeriodYear(new Date())]); state.history.forEach(h=>s.add(getPeriodYear(new Date(h.date)))); return [...s].sort((a,b)=>b-a); }
// å¹´åº¦ â†’ æœŸç•ªå·å¤‰æ›ï¼ˆ2025å¹´åº¦=57æœŸï¼‰
function fyToKi(fy) { return fy - 1968; }
function kiLabel(fy) { return `ç¬¬${fyToKi(fy)}æœŸ`; }
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function toast(msg, type='info') {
  const c=document.getElementById('toastContainer');
  const el=document.createElement('div'); el.className=`toast ${type}`; el.textContent=msg; c.appendChild(el);
  setTimeout(()=>el.remove(), 3500);
}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

// ===== INIT =====
loadLocal();
if (state.items.length===0) {
  const samples=[
    {name:'ã‚³ãƒ”ãƒ¼ç”¨ç´™ A4',category:'æ–‡å…·',stock:250,unit:'æš',alertThreshold:50,note:'500æš/æŸ'},
    {name:'ãƒœãƒ¼ãƒ«ãƒšãƒ³ï¼ˆé»’ï¼‰',category:'æ–‡å…·',stock:8,unit:'æœ¬',alertThreshold:10,note:''},
    {name:'ãƒˆãƒŠãƒ¼ã‚«ãƒ¼ãƒˆãƒªãƒƒã‚¸',category:'æ¶ˆè€—å“',stock:2,unit:'å€‹',alertThreshold:2,note:'ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ç”¨'},
    {name:'ã‚³ãƒ¼ãƒ’ãƒ¼è±†',category:'é£Ÿæ–™',stock:500,unit:'g',alertThreshold:200,note:''},
  ];
  samples.forEach(s=>{
    const item={id:state.nextId++,...s};
    state.items.push(item);
    state.history.unshift({type:'add',itemId:item.id,itemName:item.name,qty:item.stock,before:0,after:item.stock,note:'åˆæœŸãƒ‡ãƒ¼ã‚¿',person:'ã‚·ã‚¹ãƒ†ãƒ ',date:new Date().toISOString(),id:Date.now()+Math.random()});
  });
  saveLocal();
}
renderStats(); renderInventory();

// ===== è‡ªå‹•åŒæœŸï¼ˆ30åˆ†ãŠãï¼‰ =====
const AUTO_SYNC_INTERVAL = 1 * 60 * 1000; // 1åˆ†ãŠã
let autoSyncTimer = null;
let autoSyncNext = null;

function startAutoSync() {
  if (autoSyncTimer) clearInterval(autoSyncTimer);
  if (!GAS_URL) return;
  autoSyncNext = Date.now() + AUTO_SYNC_INTERVAL;
  autoSyncTimer = setInterval(async () => {
    // 1åˆ†ã”ã¨ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆå…¨å“¡ã®å¤‰æ›´ã‚’åæ˜ ï¼‰
    const loaded = await loadFromSheets();
    if (loaded) toast('ğŸ”„ æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ', 'info');
    autoSyncNext = Date.now() + AUTO_SYNC_INTERVAL;
  }, AUTO_SYNC_INTERVAL);
}

// æ®‹ã‚Šæ™‚é–“ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º
setInterval(() => {
  if (!autoSyncNext || !GAS_URL) return;
  const rem = Math.max(0, autoSyncNext - Date.now());
  const m = Math.floor(rem / 60000);
  const s = Math.floor((rem % 60000) / 1000);
  const el = document.getElementById('syncStatus');
  if (el && el.className === 'sync-ok') {
    el.textContent = `â— åŒæœŸæ¸ˆã¿ï¼ˆæ¬¡å› ${m}:${String(s).padStart(2,'0')}ï¼‰`;
  }
}, 1000);

// èµ·å‹•æ™‚ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
if (GAS_URL) {
  loadFromSheets().then(() => {
    toast('ğŸ“¥ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'info');
  });
  startAutoSync();
}
</script>
</body>
</html>
